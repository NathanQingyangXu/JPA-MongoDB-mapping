
*Chameleon* is a JPA and MongoDB mapping library based on Hibernate and MongoDB Java Driver.

image:chameleon-logo.jpg[logo, 180, 120]

== JPA and MongoDB
JPA (**J**arkata **P**ersistence **A**PI) is an SQL persistence contract aiming to bridge the gap between Java OOP (**O**bject
**O**riented **P**rogramming) paradigm and relational database model.
Hibernate library as the reference implementation of JPA is the de facto ORM (**O**bject **R**elational **M**apping) framework in which
Java developer could interact with POJOs (**P**lain **O**ld **J**ava **O**bject) whereas ORM library takes care of boilerplate JDBC processing
automatically.

MongoDB is a document NoSQL database, so seemingly JPA could not be applied directly, though the similar ORM spirit is still
highly attractive to Java developers. Furthermore, MongoDB provides many features aligning with SQL databases (e.g. transaction, table joining simulation by view, etc.),
so it seems a natural candidate to enjoy some benefits of ORM framework. Let us call it OMM (**O**bject **M**ongoDB **M**apping) then.

=== Existing Open Source Libraries (active or not)
It is not surprising that Hibernate once started an ambitious project to generalize Hibernate ORM features to all NoSQL databases.
They call it https://github.com/hibernate/hibernate-ogm[Hibernate OGM] (**O**bject **G**rid **M**apping) as a big umbrella including Infinitispan, MongoDB, Neo4j, etc.
However, it lacks some basic JPA features (e.g. Criteria and Filter) and ceased to be actively maintained any more. It is based on outdated Hibernate v5 core library models. Given the leap of faith of Hibernate
v6 release, it is extremely challenging to revive it by integrating with v6's new query model, if possible.

*Spring Data MongoDB* (https://spring.io/projects/spring-data-mongodb) is a good choice for CRUD tasks, but it lacks
other JPA features, for instance:

* OOP Inheritance Mapping
* JP-QL or HQL
* Criteria
* Lazy Loading and Entity Graph
* Second-level Cache

There used to be lesser known libraries aiming Mongodb mapping exclusively every now and again, but usually they are not actively maintained and phased out quickly.

== Chameleon: a new OMM library
The author of this library is an experienced Hibernate contributor and participated actively in both v5 and v6 development.
He humbly proposed a new OMM idea and this github project is the end result. The idea is simple and boils down to the following principles:

* loose coupling with Hibernate core library so future Hibernate evolution won't break OMM
* focus on providing a "Virtual JDBC Layer" on top of Mongodb's Java driver; the "Virtual JDBC Layer" will pass JSON instead of SQL though

=== Implementation Details
Since Hibernate v6, a unified SQM (**S**emantic **Q**uery **M**odel) was created for both JP-QL and Criteria. It is not only an elegant
tech design but also streamlines vendor specific SQL or NoSQL statement generation. In Chameleon, we could easily create parameterized Mongodb Bson command string
ready to be run by Mongodb java driver. The virtual JDBC layer will pass the JSON string instead of SQL between Hibernate and Mongodb server.
No need to overwrite or bypass Hibernate's core workflow for vendor specific SQL rendering is a standardized core feature of Hibernate, and ultimately Hibernate sits on top
of JDBC layer invariably. Our "Virtual JDBC Layer" will act as an adapter between JDBC contract and MongoDB, so the customization if outside of Hibernate's scope.

=== Some Caveats
Obviously we can't anticipate all JPA features (entity class and JPA annotations, JP-QL or HQL statements) has one-to-one
counterpart in MongoDB, but luckily MongoDB provides counterparts or simulation to great extents, e.g.:

* SQL table joining: MongoDB has collection joining simulation
* transaction: since Mongodb v4, transaction is provided
* embedding array field: since https://docs.jboss.org/hibernate/orm/6.1/migration-guide/migration-guide.html[Hibernate v6.1], JDBC's
ARRAY type is supported

== Mongodb Integration Unit Testing

Currently there are two ways to go about MongoDB integration testing:

=== Connect with External MongoDB (e.g. MongoDB Atlas)
You need to substitute your Mongodb connection URL and database name to the following two lines in *src/test/resources/hibernate
.properties*:

----
mongodb.connection.url={your_mongodb_connection_url}
mongodb.database={your_mongodb_database}
----

Remember don't add your MongoDB connection configurations in Git commit, :).

Then your testing cases should be running as expected.

=== *Testcontainers* Based Testing
Simply comment out the above external mongodb config entries
and https://java.testcontainers.org/modules/databases/mongodb/[Testcontainers approach] will take effect.
Remember you need to launch docker service beforehand; otherwise testing will fail complaining docker is not started.

There might be some MongoDB monitor related errors during the testing. Simply ignore them for testing doesn't rely on it.
